generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                       Int            @id @default(autoincrement())
  email                    String         @unique
  username                 String?        @unique
  fullName                 String?
  birthDate                DateTime?
  gender                   String?
  bio                      String?
  password                 String?
  role                     String         @default("user")
  resetToken               String?
  resetTokenExpiry         DateTime?
  emailVerificationCode    String?
  emailVerificationExpiry  DateTime?
  emailVerified            Boolean        @default(false)
  pictureUrl               String?
  profileBgUrl             String?
  posts                    Post[]
  likes                    Like[]
  createdAt                DateTime       @default(now())
  notifications            Notification[] @relation("Receiver")
  sentNotifications        Notification[] @relation("Sender")
  comments                 Comment[]
  pins                     Pin[]
  subscriptions            Subscription[] @relation("UserFollows")
  followers                Subscription[] @relation("UserFollowed")
  recentSearches           RecentSearch[] @relation("RecentSearchOwner")
  appearedInRecentSearches RecentSearch[] @relation("RecentSearchTarget")
}

model Post {
  id            Int            @id @default(autoincrement())
  text          String
  author        User?          @relation(fields: [authorId], references: [id])
  authorId      Int
  published     Boolean        @default(false)
  likesCount    Int            @default(0)
  commentsCount Int            @default(0)
  pinsCount     Int            @default(0)
  likes         Like[]
  notifications Notification[]
  comments      Comment[]
  pins          Pin[]
  hashtags      PostHashtag[]
  media         PostMedia[]
  createdAt     DateTime       @default(now())
}

model PostMedia {
  id           Int      @id @default(autoincrement())
  post         Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  postId       Int
  url          String
  thumbnailUrl String?
  smallUrl     String?
  mediumUrl    String?
  originalUrl  String?
  width        Int
  height       Int
  order        Int
  createdAt    DateTime @default(now())

  @@index([postId])
  @@index([postId, order])
}

model Like {
  id        Int      @id @default(autoincrement())
  user      User     @relation(fields: [userId], references: [id])
  userId    Int
  post      Post     @relation(fields: [postId], references: [id])
  postId    Int
  createdAt DateTime @default(now())
  @@unique([userId, postId])
}

model Notification {
  id          Int               @id @default(autoincrement())
  type        NotificationType
  message     String
  sender      User              @relation("Sender", fields: [senderId], references: [id])
  senderId    Int
  receiver    User              @relation("Receiver", fields: [receiverId], references: [id])
  receiverId  Int
  post        Post?             @relation(fields: [postId], references: [id])
  postId      Int?
  read        Boolean           @default(false)
  createdAt   DateTime          @default(now())
}

model Comment {
  id        Int      @id @default(autoincrement())
  text      String
  author    User     @relation(fields: [authorId], references: [id])
  authorId  Int
  post      Post     @relation(fields: [postId], references: [id])
  postId    Int
  createdAt DateTime @default(now())
}

model Pin {
  id        Int      @id @default(autoincrement())
  user      User     @relation(fields: [userId], references: [id])
  userId    Int
  post      Post     @relation(fields: [postId], references: [id])
  postId    Int
  createdAt DateTime @default(now())
  @@unique([userId, postId])
}

model Subscription {
  id          Int   @id @default(autoincrement())
  follower    User  @relation("UserFollows", fields: [followerId], references: [id])
  followerId  Int
  following   User  @relation("UserFollowed", fields: [followingId], references: [id])
  followingId Int
  createdAt   DateTime @default(now())
  @@unique([followerId, followingId])
}

enum NotificationType {
  LIKE
  COMMENT
  FOLLOW
  PIN
}

model Hashtag {
  id        Int            @id @default(autoincrement())
  name      String         @unique
  posts     PostHashtag[]
  createdAt DateTime       @default(now())
}

model PostHashtag {
  id        Int      @id @default(autoincrement())
  post      Post     @relation(fields: [postId], references: [id])
  postId    Int
  hashtag   Hashtag  @relation(fields: [hashtagId], references: [id])
  hashtagId Int
  createdAt DateTime @default(now())

  @@unique([postId, hashtagId])
  @@index([hashtagId])
  @@index([postId])
}

model RecentSearch {
  id              Int               @id @default(autoincrement())
  owner           User              @relation("RecentSearchOwner", fields: [ownerId], references: [id])
  ownerId         Int
  searchedUser    User?             @relation("RecentSearchTarget", fields: [searchedUserId], references: [id])
  searchedUserId  Int?
  hashtag         String?
  type            RecentSearchType
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([ownerId, createdAt])
}

enum RecentSearchType {
  USER
  HASHTAG
}
